<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DB Schema · VibesPix</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0b16;
      --card: rgba(255,255,255,0.06);
      --card-strong: rgba(255,255,255,0.12);
      --accent: #7c4dff;
      --accent-2: #00e0ff;
      --text: #f6f6f6;
      --muted: #9ba0b5;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(124,77,255,0.25), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(0,224,255,0.18), transparent 32%),
                  radial-gradient(circle at 60% 70%, rgba(124,77,255,0.2), transparent 35%),
                  var(--bg);
      color: var(--text);
      font-family: "Kanit", "Inter", system-ui, -apple-system, sans-serif;
    }

    .login-layer {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 35%, rgba(124, 77, 255, 0.28), rgba(13, 11, 22, 0.95));
      z-index: 20;
      padding: 16px;
    }
    .glass-card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.45);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      padding: 24px;
      width: min(520px, 100%);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .title { margin: 0 0 8px; font-weight: 700; letter-spacing: 0.4px; font-size: 24px; }
    .subtitle { margin: 0 0 14px; color: var(--muted); font-size: 15px; }
    .input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #9c6dff);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      width: 100%;
      letter-spacing: 0.3px;
      cursor: pointer;
      padding: 14px 16px;
      font-size: 16px;
    }
    .hidden { display: none !important; }

    .wrap {
      padding: 18px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(0,224,255,0.12);
      color: var(--text);
      font-size: 12px;
      letter-spacing: 0.2px;
      border: 1px solid rgba(0,224,255,0.25);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #223149, #1a2639);
      border: none;
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      padding: 16px;
      margin-bottom: 12px;
    }
    .muted { color: var(--muted); }
    details {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      margin-top: 10px;
    }
    summary {
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    pre {
      margin: 12px 0 0;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,0.08);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #e5e7eb;
      white-space: pre;
    }
  </style>
</head>
<body>
  <div id="login-layer" class="login-layer">
    <div class="glass-card">
      <h2 class="title">DB Schema</h2>
      <p class="subtitle">Faça login para listar schemas de todos os usuários.</p>
      <input id="login-identifier" type="text" placeholder="nome_usuario ou email" class="input" autocomplete="username" />
      <input id="login-password" type="password" placeholder="Senha" class="input" autocomplete="current-password" />
      <button id="login-btn" class="btn-primary">Entrar</button>
      <div id="login-erro" class="muted hidden">Credenciais inválidas</div>
    </div>
  </div>

  <div id="app" class="wrap hidden">
    <div class="header">
      <div>
        <div style="font-size:20px;font-weight:800;letter-spacing:0.4px;">Schemas do Mongo (todos usuários)</div>
        <div class="muted" id="subtitle">Carregando…</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span class="chip" id="chip-user"></span>
        <button id="refresh" class="btn-secondary" type="button">Atualizar</button>
        <button id="logout" class="btn-secondary" type="button">Sair</button>
      </div>
    </div>

    <div class="card">
      <div class="muted">Obs.: esta página chama <code>?format=json</code> e o backend cria collections/índices faltantes (idempotente).</div>
    </div>

    <div id="content"></div>
  </div>

  <script>
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const user = pathParts[0] || '';
    const baseApi = `/${user}/api`;

    const loginLayer = document.getElementById('login-layer');
    const app = document.getElementById('app');
    const content = document.getElementById('content');

    document.getElementById('chip-user').textContent = user ? `Painel: ${user}` : 'Painel';

    function showLogin(msg) {
      if (msg) {
        const el = document.getElementById('login-erro');
        el.textContent = msg;
        el.classList.remove('hidden');
      }
      loginLayer.classList.remove('hidden');
      app.classList.add('hidden');
    }

    function showApp() {
      document.getElementById('login-erro').classList.add('hidden');
      loginLayer.classList.add('hidden');
      app.classList.remove('hidden');
    }

    function render(databases, warning) {
      content.innerHTML = '';

      const subtitle = document.getElementById('subtitle');
      const total = Array.isArray(databases) ? databases.length : 0;
      subtitle.textContent = warning ? `Total: ${total} · Aviso: ${warning}` : `Total: ${total}`;

      if (!total) {
        const empty = document.createElement('div');
        empty.className = 'card muted';
        empty.textContent = 'Nenhum schema encontrado.';
        content.appendChild(empty);
        return;
      }

      databases.forEach((entry) => {
        const card = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('div');
        title.style.fontWeight = '800';
        title.style.fontSize = '16px';
        title.textContent = entry.user;
        card.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.style.marginTop = '6px';
        const created = Array.isArray(entry.createdCollections) ? entry.createdCollections.join(', ') : '';
        meta.textContent = created ? `Collections criadas agora: ${created}` : 'Collections já estavam OK.';
        card.appendChild(meta);

        const details = document.createElement('details');
        const summary = document.createElement('summary');
        const left = document.createElement('span');
        left.textContent = 'Ver JSON do schema';
        const right = document.createElement('span');
        right.className = 'chip';
        const missing = Array.isArray(entry.missingRequired) ? entry.missingRequired.length : 0;
        right.textContent = missing ? `Faltando: ${missing}` : 'OK';
        summary.appendChild(left);
        summary.appendChild(right);
        details.appendChild(summary);

        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(entry, null, 2);
        details.appendChild(pre);

        card.appendChild(details);
        content.appendChild(card);
      });
    }

    async function loadSchemas() {
      document.getElementById('subtitle').textContent = 'Carregando…';
      content.innerHTML = '';

      const res = await fetch(`${baseApi}/db-schema?format=json`, {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
      });

      if (res.status === 401) {
        showLogin('Faça login para continuar.');
        throw new Error('unauthorized');
      }

      const data = await res.json();
      if (!res.ok || !data?.ok) {
        const msg = data?.error || 'Falha ao carregar schema';
        throw new Error(msg);
      }

      showApp();
      render(data.databases || [], data.warning || null);
    }

    document.getElementById('login-btn').onclick = async function() {
      const identifier = document.getElementById('login-identifier').value.trim();
      const password = document.getElementById('login-password').value;
      document.getElementById('login-erro').classList.add('hidden');

      try {
        const res = await fetch(`${baseApi}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ identifier, password })
        });
        if (!res.ok) throw new Error('Credenciais inválidas');
        await loadSchemas();
      } catch (err) {
        showLogin(err.message || 'Credenciais inválidas');
      }
    };

    document.getElementById('logout').onclick = async function() {
      try { await fetch(`${baseApi}/logout`, { method: 'POST', credentials: 'include' }); } catch {}
      showLogin('');
    };

    document.getElementById('refresh').onclick = async function() {
      try {
        await loadSchemas();
      } catch (err) {
        if (String(err?.message || '') !== 'unauthorized') {
          showLogin(err?.message || 'Falha ao atualizar');
        }
      }
    };

    // Tenta usar sessão existente
    (async () => {
      try {
        await loadSchemas();
      } catch (err) {
        if (String(err?.message || '') !== 'unauthorized') {
          showLogin(err?.message || '');
        }
      }
    })();
  </script>
</body>
</html>
