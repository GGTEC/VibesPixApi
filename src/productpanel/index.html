<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Produtos · VibesPix</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0b16;
      --card: rgba(255, 255, 255, 0.06);
      --card-strong: rgba(255, 255, 255, 0.12);
      --accent: #7c4dff;
      --accent-2: #00e0ff;
      --text: #f6f6f6;
      --muted: #9ba0b5;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(124, 77, 255, 0.25), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(0, 224, 255, 0.18), transparent 32%),
                  radial-gradient(circle at 60% 70%, rgba(124, 77, 255, 0.2), transparent 35%),
                  var(--bg);
      color: var(--text);
      font-family: "Kanit", "Inter", system-ui, -apple-system, sans-serif;
      overflow-y: auto;
      padding: 16px 10px 36px;
    }
    .login-layer {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 50% 35%, rgba(124, 77, 255, 0.28), rgba(13, 11, 22, 0.95));
      z-index: 10;
      padding: 16px;
    }
    .glass-card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      padding: 24px;
      width: min(560px, 100%);
    }
    .login-box {
      width: min(520px, 100%);
      text-align: center;
      gap: 12px;
      display: flex;
      flex-direction: column;
    }
    .title { margin: 0 0 12px; font-weight: 700; letter-spacing: 0.5px; font-size: 24px; }
    .subtitle { margin: 0 0 20px; color: var(--muted); font-size: 15px; }
    .card {
      max-width: 560px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      padding: 20px;
      align-self: center;
      width: 100%;
    }
    h1 { margin: 0 0 4px; font-size: 24px; }
    p.lead { margin: 0 0 16px; color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
    .section {
      background: var(--card-strong);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    .section h3 { margin: 0 0 10px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .input, select.input, textarea.input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-size: 16px;
      outline: none;
      transition: border 0.2s ease, transform 0.1s ease;
    }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.22); transform: translateY(-1px); }
    /* Melhora contraste do dropdown nativo */
    select.input {
      border-radius: 14px;
      padding-right: 32px;
      background: rgba(255, 255, 255, 0.06);
    }
    select.input option {
      background: #120f25;
      color: var(--text);
      padding: 12px 14px;
    }
    select.input option:first-child { border-radius: 12px 12px 0 0; }
    select.input option:last-child { border-radius: 0 0 12px 12px; }
    select.input option:checked {
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.5), rgba(0, 224, 255, 0.4));
      color: #fff;
    }
    textarea.input { min-height: 160px; resize: vertical; font-family: "Fira Code", ui-monospace, monospace; }
    .label { color: var(--muted); font-size: 13px; margin-bottom: 6px; display: block; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .form-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; align-items: start; }
    .full-span { grid-column: 1 / -1; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; flex-direction: column; }
    .btn {
      border: none;
      border-radius: 12px;
      padding: 14px 14px;
      font-weight: 700;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, var(--accent), #9c6dff);
      box-shadow: 0 10px 30px rgba(124, 77, 255, 0.35);
      transition: transform 0.12s ease, box-shadow 0.2s ease;
      font-size: 16px;
      width: 100%;
    }
    .btn.secondary { background: linear-gradient(135deg, #223149, #1a2639); box-shadow: none; }
    .btn.danger { background: linear-gradient(135deg, #ff5f6d, #ff8a7a); }
    .btn:active { transform: translateY(1px); }
    .toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 999; }
    .toast { min-width: 240px; max-width: 320px; padding: 12px 14px; border-radius: 12px; background: linear-gradient(135deg, rgba(0, 224, 255, 0.14), rgba(124, 77, 255, 0.2)); border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); box-shadow: 0 14px 42px rgba(0, 0, 0, 0.35); opacity: 0; transform: translateY(-12px); animation: toast 0.4s forwards; font-size: 14px; }
    .toast.error { background: linear-gradient(135deg, rgba(255, 76, 106, 0.18), rgba(255, 139, 167, 0.16)); border-color: rgba(255, 76, 106, 0.4); }
    @keyframes toast { to { opacity: 1; transform: translateY(0); } }
    .file-input { position: relative; background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; }
    .file-input input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .file-name { color: var(--muted); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .image-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 8px; }
    .image-card { cursor: pointer; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; background: rgba(255,255,255,0.04); display: flex; flex-direction: column; gap: 6px; transition: border 0.15s ease, box-shadow 0.2s ease; }
    .image-card:hover { border-color: rgba(124,77,255,0.6); box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .image-card.selected { border-color: rgba(0,224,255,0.8); box-shadow: 0 10px 30px rgba(0,224,255,0.22); }
    .image-card img { width: 100%; height: 96px; object-fit: cover; border-radius: 10px; background: rgba(0,0,0,0.12); }
    .image-name { font-size: 13px; color: var(--text); word-break: break-all; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 12px; }
    .modal { background: var(--card); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; width: min(720px, 100%); max-height: 90vh; overflow: auto; box-shadow: 0 24px 70px rgba(0,0,0,0.45); padding: 18px; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    .modal-title { margin: 0; font-size: 18px; }
    .modal-close { background: transparent; border: none; color: var(--text); font-size: 20px; cursor: pointer; padding: 6px; line-height: 1; }
    .modal-upload { margin-bottom: 12px; }
    .hidden { display: none; }
    .card-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 100vh;
      padding: 0 4px;
    }

    @media (max-width: 900px) {
      body { padding: 14px 8px 28px; }
      .card { padding: 16px; max-width: 100%; }
      .row { grid-template-columns: 1fr; gap: 12px; }
      .form-grid { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; gap: 12px; }
      .glass-card { padding: 20px; width: 100%; }
      .login-layer { padding: 10px; }
      .title { font-size: 22px; }
      .subtitle { font-size: 14px; }
      .input, .btn { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="login" class="login-layer">
    <div class="glass-card login-box">
      <h2 class="title">Painel do Usuário</h2>
      <p class="subtitle">Faça login com nome de usuário ou e-mail e senha.</p>
      <input id="loginIdentifier" class="input" placeholder="nome_usuario ou email" />
      <input id="loginPassword" type="password" class="input" placeholder="Senha" />
      <button class="btn" id="btnLogin">Entrar</button>
      <div id="loginError" class="toast error hidden">Credenciais inválidas</div>
    </div>
  </div>
  <div class="toast-container" id="toasts"></div>
  <div class="card-wrapper">

    <div class="card hidden" id="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <div>
          <h1>Gerenciar Produtos</h1>
          <p class="lead">Crie, edite ou remova produtos deste usuário.</p>
        </div>
        <button class="btn secondary" id="btnLogout" style="width:auto;padding:12px 14px;">Sair</button>
      </div>
      <div class="section">
        <div class="row">
          <div>
            <label class="label">Produto existente</label>
            <select id="productSelect" class="input"></select>
          </div>
        </div>

        <div id="productFormSection" class="section hidden" style="margin-top:12px;background: transparent;padding: 0px;border: 0px;">
          <div class="form-grid">
            <div>
              <label class="label">ID do produto</label>
              <input id="newProductId" class="input" placeholder="ex: vip_gold" />
            </div>
            <div>
              <label class="label">Título</label>
              <input id="productTitle" class="input" placeholder="ex: VIP Gold" />
            </div>
            <div>
              <label class="label">Valor (exibição)</label>
              <input id="productPrice" type="number" class="input" placeholder="ex: 500" />
            </div>
            <div>
              <label class="label">Quantidade</label>
              <input id="productQty" type="number" class="input" placeholder="ex: 1" />
            </div>
            <div class="full-span">
              <label class="label">Comandos (um por linha; use {player} / {username})</label>
              <textarea id="productCmds" class="input" spellcheck="false" placeholder="give {player} diamond 1"></textarea>
            </div>
            <div class="full-span">
              <label class="label">Imagem (URL)</label>
              <input id="productImg" class="input" placeholder="Escolha uma imagem" readonly style="cursor:pointer;" />
              <input id="productImgUrl" type="hidden" />
              <small style="color: var(--muted);">Clique para escolher ou enviar uma imagem</small>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="btnSave">Salvar produto</button>
            <button class="btn danger" id="btnDelete">Remover produto</button>
            <button class="btn secondary" id="btnClear">Limpar formulário</button>
          </div>
        </div>
      </div>
    </div>


  </div>

  <div id="imageModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Imagens do usuário</h3>
        <button class="modal-close" id="modalClose">×</button>
      </div>
      <div class="modal-upload">
        <label class="label">Enviar nova imagem</label>
        <div class="file-input">
          <span class="file-name" id="modalFileName">Nenhum arquivo</span>
          <input type="file" id="modalFileInput" accept="image/*" />
        </div>
      </div>
      <div>
        <label class="label">Galeria</label>
        <div id="imageGallery" class="image-gallery"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const user = location.pathname.split("/").filter(Boolean)[0] || "ggtec";
    let loggedIn = false;
    let config = null;
    let produtos = {};
    let imagens = [];
    let modalOpen = false;

    function showForm(show) {
      const form = $("productFormSection");
      if (!form) return;
      form.classList.toggle("hidden", !show);
    }

    function getFileNameFromUrl(url) {
      if (!url) return "";
      try {
        const parts = url.split("?")[0].split("#")[0].split("/");
        return parts[parts.length - 1] || url;
      } catch (e) {
        return url;
      }
    }

    function setImageValue(url) {
      const name = getFileNameFromUrl(url);
      $("productImgUrl").value = url || "";
      $("productImg").value = name || "";
    }

    function getImageValue() {
      return $("productImgUrl").value.trim();
    }

    function toast(msg, isError = false) {
      const box = document.createElement("div");
      box.className = "toast" + (isError ? " error" : "");
      box.textContent = msg;
      $("toasts").appendChild(box);
      setTimeout(() => box.remove(), 3800);
    }

    async function fetchConfig() {
      const res = await fetch(`/${user}/api/config`, { credentials: "include" });
      if (!res.ok) throw new Error("Não autorizado ou config ausente");
      return res.json();
    }

    async function saveConfig(produtosAtualizados) {
      const body = {
        rcon: config?.rcon || { host: "", port: "", password: "" },
        produtos: produtosAtualizados
      };
      const res = await fetch(`/${user}/api/config`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || "Erro ao salvar");
      }
      return res.json();
    }

    async function fetchImages() {
      const res = await fetch(`/${user}/api/list-images`, {
        credentials: "include"
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || "Erro ao listar imagens");
      }
      return res.json();
    }

    function renderImageGallery() {
      const container = $("imageGallery");
      if (!container) return;
      container.innerHTML = "";
      if (!imagens.length) {
        const empty = document.createElement("p");
        empty.className = "label";
        empty.style.margin = "0";
        empty.textContent = "Nenhuma imagem enviada.";
        container.appendChild(empty);
        return;
      }
      const current = getImageValue();
      imagens.forEach(({ name, url }) => {
        const card = document.createElement("div");
        card.className = "image-card" + (url === current ? " selected" : "");
        const img = document.createElement("img");
        img.src = url;
        img.alt = name;
        const title = document.createElement("div");
        title.className = "image-name";
        title.textContent = name;
        card.onclick = () => {
          setImageValue(url);
          renderImageGallery();
          if (modalOpen) closeImageModal();
        };
        card.appendChild(img);
        card.appendChild(title);
        container.appendChild(card);
      });
    }

    function fillSelect(selectedId = "") {
      const sel = $("productSelect");
      sel.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Selecione um produto";
      placeholder.disabled = true;
      placeholder.selected = !selectedId;
      sel.appendChild(placeholder);
      const optNew = document.createElement("option");
      optNew.value = "__new";
      optNew.textContent = "Novo produto";
      optNew.selected = selectedId === "__new";
      sel.appendChild(optNew);
      Object.keys(produtos).forEach(key => {
        const o = document.createElement("option");
        o.value = key;
        o.textContent = key;
        o.selected = selectedId === key;
        sel.appendChild(o);
      });
      if (selectedId) sel.value = selectedId;
    }

    function loadProduct(key) {
      const p = produtos[key];
      if (!p) return;
      $("newProductId").value = key;
      $("productTitle").value = p.title || "";
      $("productPrice").value = p.valor ?? "";
      $("productQty").value = p.quantity ?? "";
      const cmds = Array.isArray(p.comandos)
        ? p.comandos
        : Array.isArray(p.comando)
          ? p.comando
          : p.comando
            ? [p.comando]
            : p.comandos
              ? [p.comandos]
              : [];
      $("productCmds").value = cmds.join("\n");
      setImageValue(p.imagem || "");
      renderImageGallery();
      showForm(true);
    }

    function clearForm(keepSelection = false) {
      if (!keepSelection) $("productSelect").value = "";
      $("newProductId").value = "";
      $("productTitle").value = "";
      $("productPrice").value = "";
      $("productQty").value = "";
      $("productCmds").value = "";
      setImageValue("");
      $("modalFileName").textContent = "Nenhum arquivo";
      renderImageGallery();
    }

    async function uploadImage(file) {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch(`/${user}/api/upload-image`, {
        method: "POST",
        credentials: "include",
        body: form
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || "Falha no upload");
      }
      return res.json();
    }

    function openImageModal() {
      const modal = $("imageModal");
      if (!modal) return;
      modal.style.display = "flex";
      modalOpen = true;
      renderImageGallery();
    }

    function closeImageModal() {
      const modal = $("imageModal");
      if (!modal) return;
      modal.style.display = "none";
      modalOpen = false;
    }

    $("btnLogin").onclick = async () => {
      const identifier = $("loginIdentifier").value.trim();
      const password = $("loginPassword").value;
      try {
        const res = await fetch(`/${user}/api/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ identifier, password })
        });
        if (!res.ok) throw new Error("Credenciais inválidas");
        loggedIn = true;
        config = await fetchConfig();
        produtos = config.produtos || {};
        const imagesRes = await fetchImages();
        imagens = imagesRes.files || [];
        renderImageGallery();
        fillSelect();
        showForm(false);
        $("login").classList.add("hidden");
        $("panel").classList.remove("hidden");
        toast("Autenticado");
      } catch (err) {
        $("loginError").textContent = err.message || "Credenciais inválidas";
        $("loginError").classList.remove("hidden");
        setTimeout(() => $("loginError").classList.add("hidden"), 2200);
      }
    };

    $("btnLogout").onclick = async () => {
      try {
        await fetch(`/${user}/api/logout`, { method: "POST", credentials: "include" });
      } catch {}
      loggedIn = false;
      clearForm();
      $("panel").classList.add("hidden");
      $("login").classList.remove("hidden");
    };

    async function trySessionLogin() {
      try {
        config = await fetchConfig();
        produtos = config.produtos || {};
        const imagesRes = await fetchImages();
        imagens = imagesRes.files || [];
        renderImageGallery();
        fillSelect();
        showForm(false);
        $("login").classList.add("hidden");
        $("panel").classList.remove("hidden");
        loggedIn = true;
      } catch (_) {
        // sessão inválida ou ausente: mantém tela de login
      }
    }

    window.addEventListener("load", trySessionLogin);

    $("productSelect").onchange = (e) => {
      const key = e.target.value;
      if (key === "__new") {
        clearForm(true);
        showForm(true);
        return;
      }
      if (key) {
        loadProduct(key);
      } else {
        showForm(false);
      }
    };

    $("btnClear").onclick = () => clearForm(true);

    $("btnSave").onclick = async () => {
      const id = ($("newProductId").value || "").trim();
      if (!id) return toast("Informe o ID do produto", true);
      const title = $("productTitle").value.trim();
      const valor = Number($("productPrice").value) || 0;
      const quantity = Number($("productQty").value) || 1;
      const cmds = $("productCmds").value.split(/\n+/).map(c => c.trim()).filter(Boolean);
      const imagem = getImageValue();
      produtos[id] = {
        title,
        valor,
        quantity,
        comandos: cmds,
        imagem
      };
      try {
        await saveConfig(produtos);
        fillSelect(id);
        $("productSelect").value = id;
        showForm(true);
        toast("Produto salvo");
      } catch (err) {
        toast("Erro ao salvar: " + err.message, true);
      }
    };

    $("btnDelete").onclick = async () => {
      const id = ($("newProductId").value || "").trim();
      if (!id || !produtos[id]) return toast("Selecione um produto para remover", true);
      delete produtos[id];
      try {
        await saveConfig(produtos);
        fillSelect();
        clearForm();
        showForm(false);
        toast("Produto removido");
      } catch (err) {
        toast("Erro ao remover: " + err.message, true);
      }
    };

    $("modalFileInput").onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      $("modalFileName").textContent = file.name;
      try {
        const res = await uploadImage(file);
        if (res?.url) {
          setImageValue(res.url);
          imagens = [...imagens.filter((i) => i.url !== res.url), { name: file.name, url: res.url }];
          renderImageGallery();
          toast("Imagem enviada");
        }
      } catch (err) {
        toast("Upload falhou: " + err.message, true);
      }
    };

    $("productImg").onclick = () => openImageModal();
    $("modalClose").onclick = () => closeImageModal();
    $("imageModal").addEventListener("click", (e) => {
      if (e.target === $("imageModal")) closeImageModal();
    });
  </script>
</body>
</html>