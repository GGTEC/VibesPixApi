<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Doar · VibesPix</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0b16;
      --card: rgba(255,255,255,0.08);
      --card-strong: rgba(255,255,255,0.14);
      --accent: #7c4dff;
      --accent-2: #00e0ff;
      --text: #f5f7fb;
      --muted: #a3a8bb;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(124, 77, 255, 0.24), transparent 36%),
                  radial-gradient(circle at 78% 12%, rgba(0, 224, 255, 0.18), transparent 34%),
                  radial-gradient(circle at 60% 70%, rgba(124, 77, 255, 0.16), transparent 40%),
                  var(--bg);
      color: var(--text);
      font-family: "Kanit", "Inter", system-ui, sans-serif;
      padding: 24px 16px 120px;
    }
    .container {
      max-width: 780px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
    }
	header {
	  text-align: center;
	}
    h1 { margin: 0 0 6px; font-size: 28px; }
    p.lead { margin: 0 0 12px; color: var(--muted); }
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .label { font-size: 14px; color: var(--muted); }
    .input, select {
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    .input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,77,255,0.22); }
    textarea { min-height: 120px; resize: vertical; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .btn {
      background: linear-gradient(135deg, var(--accent), #9c6dff);
      color: white;
      border: none;
      padding: 14px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease;
      width: 100%;
      font-size: 16px;
    }
    .btn:hover { box-shadow: 0 12px 30px rgba(124,77,255,0.35); }
    .btn:active { transform: translateY(1px); }
    .notice { color: #ffb3c0; margin-top: 8px; min-height: 20px; }
    .footer { text-align: center; color: var(--muted); font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1 id="donate-title">Enviar mensagem</h1>
      <p class="lead" id="donate-lead">Envie um recado falado com o valor que preferir.</p>
    </header>

    <section class="card">
      <div class="row">
        <div class="field">
          <label class="label" for="donate-name">Seu nome</label>
          <input id="donate-name" class="input" placeholder="Ex: SeuNickname" maxlength="60">
        </div>
        <div class="field">
          <label class="label" for="donate-amount">Valor (R$)</label>
          <input id="donate-amount" class="input" type="number" min="1" step="0.50" placeholder="Ex: 5.00">
        </div>
      </div>

      <div class="field">
        <label class="label" for="donate-tts">Texto que será falado (máx. 300 caracteres)</label>
        <textarea id="donate-tts" class="input" maxlength="300" placeholder="Digite sua mensagem"></textarea>
      </div>

      <div class="field">
        <label class="label" for="donate-voice">Voz</label>
        <select id="donate-voice">
          <option value="">Usar voz padrão do streamer</option>
        </select>
      </div>

      <div class="notice" id="donate-error"></div>
      <button id="donate-submit" class="btn">Prosseguir para pagamento</button>
    </section>

    <p class="footer">Pagamentos via InfinitePay. Você será redirecionado para concluir.</p>
  </div>

  <script>
    const basePath = window.location.pathname.replace(/\/?donate.*$/, '');
    const baseApi = basePath + '/api';
    const voiceSelect = document.getElementById('donate-voice');
    const errorEl = document.getElementById('donate-error');

    const voices = [
      { value: "pt-BR-ThalitaMultilingualNeural", label: "pt-BR - ThalitaMultilingualNeural (Feminino)" },
      { value: "pt-BR-AntonioNeural", label: "pt-BR - AntonioNeural (Masculino)" },
      { value: "pt-BR-FranciscaNeural", label: "pt-BR - FranciscaNeural (Feminino)" },
      { value: "pt-PT-DuarteNeural", label: "pt-PT - DuarteNeural (Masculino)" },
      { value: "pt-PT-RaquelNeural", label: "pt-PT - RaquelNeural (Feminino)" }
    ];

    function populateVoices() {
      voices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.value;
        opt.textContent = v.label;
        voiceSelect.appendChild(opt);
      });
    }

    function showError(msg) {
      errorEl.textContent = msg || '';
    }

    function formatCents(value) {
      const num = Number(value);
      if (!Number.isFinite(num) || num <= 0) return 0;
      return Math.round(num * 100);
    }

    async function loadLead() {
      try {
        const res = await fetch(`${baseApi}/config`);
        if (!res.ok) return;
        const data = await res.json();
        const titleEl = document.getElementById('donate-title');
        const leadEl = document.getElementById('donate-lead');
        if (data.home?.name) titleEl.textContent = data.home.name;
        if (data.home?.lead) leadEl.textContent = data.home.lead;
      } catch (err) {
        console.warn('Falha ao carregar lead', err);
      }
    }

    async function submitDonate() {
      const name = document.getElementById('donate-name').value.trim() || 'Cliente';
      const amountInput = document.getElementById('donate-amount').value;
      const ttsRaw = document.getElementById('donate-tts').value || '';
      const tts = ttsRaw.trim().slice(0, 300);
      const voice = voiceSelect.value || undefined;
      const cents = formatCents(amountInput);

      if (!cents || cents <= 0) {
        showError('Informe um valor válido.');
        return;
      }
      if (!tts) {
        showError('Digite a mensagem que será falada.');
        return;
      }

      showError('');
      const btn = document.getElementById('donate-submit');
      btn.disabled = true;
      btn.textContent = 'Gerando pagamento...';

      try {
        const body = {
          customer_name: name,
          order_id: `donate-${Date.now()}`,
          tts_text: tts,
          tts_voice: voice,
          items: [
            {
              description: 'donate',
              quantity: 1,
              amount: cents
            }
          ],
          totalPrice: cents
        };

        const res = await fetch(`${baseApi}/create_checkout_infinitepay`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        let data = null;
        let raw = '';
        try {
          data = await res.json();
        } catch (err) {
          try { raw = await res.text(); } catch {}
        }

        if (!res.ok) {
          const msg = data?.error || data?.message || raw || 'Erro ao criar checkout';
          throw new Error(msg);
        }

        const checkoutUrl = data?.url || data?.data?.url;
        if (checkoutUrl) {
          window.location.href = checkoutUrl;
        } else {
          throw new Error('Resposta sem URL de pagamento');
        }
      } catch (err) {
        console.error(err);
        showError(err.message || 'Erro ao iniciar pagamento');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Prosseguir para pagamento';
      }
    }

    populateVoices();
    loadLead();
    document.getElementById('donate-submit').onclick = submitDonate;
  </script>
</body>
</html>
