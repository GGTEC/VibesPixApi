<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <title>Loja do Streamer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0b16;
      --card: rgba(255,255,255,0.06);
      --card-strong: rgba(255,255,255,0.12);
      --accent: #7c4dff;
      --accent-2: #00e0ff;
      --text: #f5f7fb;
      --muted: #a3a8bb;
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(124, 77, 255, 0.24), transparent 36%),
                  radial-gradient(circle at 78% 12%, rgba(0, 224, 255, 0.18), transparent 34%),
                  radial-gradient(circle at 60% 70%, rgba(124, 77, 255, 0.16), transparent 40%),
                  var(--bg);
      color: var(--text);
      font-family: "Kanit", "Inter", system-ui, sans-serif;
      padding: 24px 16px 120px; /* espaço para footer fixo */
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      min-height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p.lead { margin: 0 0 20px; color: var(--muted); }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      margin-bottom: 14px;
    }
    .product {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 12px;
      align-items: center;
      min-height: 120px;
      max-height: 140px;
    }
    .product img {
      width: 84px;
      height: 84px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
    }
    .product .info { display: flex; flex-direction: column; gap: 4px; }
    .product h3 { margin: 0; font-size: 18px; }
    .product p { margin: 4px 0 0; color: var(--muted); font-size: 14px; }
    .price { font-weight: 700; color: var(--accent-2); display: flex; font-size: 18px;
      justify-content: flex-start;}
    .btn {
      background: linear-gradient(135deg, var(--accent), #9c6dff);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.2s ease;
      min-width: 120px;
    }
    .btn:hover { box-shadow: 0 12px 30px rgba(124,77,255,0.35); }
    .btn:active { transform: translateY(1px); }
    .notice { color: #ffb3c0; margin-top: 8px; }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }
    .input {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline: none;
      font-size: 15px;
    }
    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,77,255,0.22);
    }
    .grid { display: grid; gap: 12px; align-items: start; align-content: start; }
    #products {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 12px;
      align-content: start;
      align-items: start;
    }
    .check-col {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .check-col input[type="checkbox"] {
      appearance: none;
      width: 24px;
      height: 24px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      box-shadow: 0 6px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.08);
      position: relative;
      transition: border 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .check-col input[type="checkbox"]:focus { outline: 2px solid rgba(124,77,255,0.35); outline-offset: 2px; }
    .check-col input[type="checkbox"]:checked {
      border-color: rgba(0,224,255,0.6);
      background: linear-gradient(135deg, #7c4dff, #00e0ff);
      box-shadow: 0 10px 22px rgba(124,77,255,0.35);
    }
    .check-col input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -54%);
      color: #fff;
      font-weight: 800;
      font-size: 24px;
    }
    .qty {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 6px 8px;
      justify-content: space-between;
    }
    .qty button {
      background: transparent;
      border: none;
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      width: 26px;
      height: 26px;
      border-radius: 8px;
    }
    .qty button:hover { background: rgba(255,255,255,0.08); }
    .qty span { min-width: 20px; text-align: center; display: inline-block; }
    .footer-actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px 16px 16px;
      background: linear-gradient(180deg, rgba(13,11,22,0.2), rgba(13,11,22,0.95));
      backdrop-filter: blur(10px);
      box-shadow: 0 -8px 30px rgba(0,0,0,0.35);
      z-index: 20;
    }
    .footer-inner {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      justify-content: flex-end;
    }
    .summary {
      margin-top: 16px;
      display: none;
      gap: 10px;
    }
    .summary ul {
      padding-left: 16px;
      margin: 8px 0;
      color: var(--text);
    }
    .summary h4 { margin: 0 0 8px; }
    .divider { border: none; border-top: 1px solid rgba(255,255,255,0.08); margin: 12px 0; }
    .hidden { display: none !important; }
    .summary-list {
      display: grid;
      gap: 10px;
      margin-top: 30px;
    }
    .summary-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .summary-item .title { margin: 0; font-weight: 700; }
    .summary-item .meta { margin: 0; color: var(--muted); font-size: 14px; }
    .action-row { display: flex; gap: 10px; margin-top: 22px; }
    .btn-ghost {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text);
    }
    .btn-ghost:hover { box-shadow: none; background: rgba(255,255,255,0.08); }
    @media (max-width: 900px) {
      body { padding: 18px 12px 120px; }
      .container { gap: 12px; }
      .card { padding: 16px; }
      .product {
        grid-template-columns: 92px 1fr;
        grid-template-areas:
          "img title"
          "img meta"
          "check qty";
        align-items: start;
        max-height: none;
      }
      .product img { width: 92px; height: 92px; grid-area: img; }
      .product .info { grid-area: title; }
      .product h3 { font-size: 16px; margin-bottom: 2px; }
      .product p { font-size: 13px; grid-area: meta; }
      .price { font-size: 16px; }
      .check-col { grid-area: check; justify-content: flex-start; align-self: center; }
      .qty {
        grid-area: qty;
        width: 40%;
        justify-content: space-between;
        margin-top: 4px;
        padding: 4px 6px;
        font-size: 14px;
        justify-self: end;
      }
      .qty button { width: 28px; height: 28px; }
      .btn { width: 100%; font-size: 16px; }
      .footer-actions { padding: 12px; }
      .footer-inner { justify-content: center; }
      .field .input { font-size: 16px; }
    }

    header.card {
      text-align: center;
    }

  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1 id="store-title">Loja interativa</h1>
      <p class="lead">Compre aqui interações para a live do GGTEC!
          Escolha entre diversas opções de interações para tornar a live mais divertida e envolvente.</p>
    </header>

    <section id="products" class="grid"></section>
    <div class="footer-actions" id="footer-actions">
      <div class="footer-inner">
        <button id="btn-prosseguir" class="btn">Prosseguir</button>
      </div>
    </div>
    <div id="error" class="notice"></div>

    <div id="summary" class="card summary">
      <div class="field">
        <label for="final-name">Nome que aparece na cabeça do mob</label>
        <input id="final-name" class="input" placeholder="Ex: SeuNickname">
      </div>
      <div class="field">
        <label for="final-tts">Texto que será falado (máx. 300 caracteres)</label>
        <input id="final-tts" class="input" placeholder="Ex: Olá, seja bem-vindo!" maxlength="300">
      </div>
      <hr class="divider">
      <h4>Revisar compra</h4>
      <div id="summary-list" class="summary-list"></div>
      <p id="summary-total" class="price"></p>
      

      <div class="action-row">
        <button id="btn-voltar" class="btn btn-ghost">Voltar</button>
        <button id="btn-confirmar" class="btn" style="flex: 1;">Confirmar e pagar</button>
      </div>
    </div>
  </div>

  <script>
    const basePath = window.location.pathname.replace(/\/?loja.*$/, '');
    const baseApi = basePath + '/api';
    const productsEl = document.getElementById('products');
    const errorEl = document.getElementById('error');
    const summaryEl = document.getElementById('summary');
    const summaryListEl = document.getElementById('summary-list');
    const summaryTotalEl = document.getElementById('summary-total');
    const footerActionsEl = document.getElementById('footer-actions');
    const backBtn = document.getElementById('btn-voltar');
    const selections = new Map(); // id -> {produto, qty}
    const defaultBodyBackground = getComputedStyle(document.body).background;

    function showError(msg) {
      errorEl.textContent = msg || '';
    }

    function applyPageBackground(bgUrl) {
      if (!bgUrl) {
        document.body.style.background = defaultBodyBackground;
        document.body.style.backgroundSize = '';
        document.body.style.backgroundPosition = '';
        document.body.style.backgroundRepeat = '';
        document.body.style.backgroundAttachment = '';
        return;
      }

      document.body.style.background = `linear-gradient(135deg, rgba(13,11,22,0.82), rgba(13,11,22,0.7)), url('${bgUrl}')`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundRepeat = 'no-repeat';
      document.body.style.backgroundAttachment = 'fixed';
    }

    function formatPrice(v) {
      if (v == null) return '—';
      const num = Number(v);
      return 'R$ ' + (isNaN(num) ? v : (num / 100).toFixed(2));
    }

    async function loadConfig() {
      showError('');

      const res = await fetch(`${baseApi}/config`);
      if (!res.ok) {
        showError('Não foi possível carregar config pública.');
        return;
      }
      const data = await res.json();
      renderProducts(data);
      if (data.home) {
        const leadEl = document.querySelector('p.lead');
        const titleEl = document.getElementById('store-title');
        if (leadEl && data.home.lead) leadEl.textContent = data.home.lead;
        if (titleEl && data.home.name) titleEl.textContent = data.home.name;

        const headerEl = document.querySelector('header.card');
        const bannerBg = data.home.bannerBg || data.home.leadBg || data.home.leadBackground;
        const headerBg = bannerBg || data.home.storeBg || data.home.donateBg;
        if (headerEl && headerBg) {
          headerEl.style.backgroundImage = `linear-gradient(135deg, rgba(13,11,22,0.72), rgba(13,11,22,0.6)), url('${headerBg}')`;
          headerEl.style.backgroundSize = 'cover';
          headerEl.style.backgroundPosition = 'center';
        }

        const pageBg = data.home.pageBg || data.home.storeBg;
        applyPageBackground(pageBg);
      }
    }

    function renderProducts(config) {
      productsEl.innerHTML = '';
      const produtos = config.produtos || {};
      const entries = Object.entries(produtos)
        .sort((a, b) => {
          const va = getValor(a[1]);
          const vb = getValor(b[1]);
          if (va === vb) return 0;
          return va < vb ? -1 : 1;
        });
      if (!entries.length) {
        productsEl.innerHTML = '<p class="notice">Nenhum produto configurado.</p>';
        return;
      }

      entries.forEach(([id, p]) => {
        const card = document.createElement('div');
        card.className = 'card product';

        const img = document.createElement('img');
        img.src = p.imagem || 'https://vibesbot.com.br/assets/img/about.png';
        img.alt = id;

        const info = document.createElement('div');
        const title = document.createElement('h3');
        const qtd = document.createElement('span');
        const meta = document.createElement('p');
        
        info.className = 'info';
        title.innerHTML = `${p.title}`;
        const qtdValue = p.quantity ?? p.qty ?? '—';
        qtd.innerHTML = `• Qtd: ${qtdValue}`;
        const valueRaw = p.valor ?? p.price;
        const valuePrice = valueRaw != null ? formatPrice(valueRaw) : '—';
        meta.innerHTML = `<span class="price">${valuePrice}</span>`;
        info.appendChild(title);
        info.appendChild(qtd);
        info.appendChild(meta);

        const checkCol = document.createElement('div');
        checkCol.className = 'check-col';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.onchange = () => toggleProduct(id, p, chk.checked);
        checkCol.appendChild(chk);

        const qtyCol = document.createElement('div');
        qtyCol.className = 'qty';
        const minus = document.createElement('button');
        minus.type = 'button';
        minus.textContent = '-';
        const qtySpan = document.createElement('span');
        qtySpan.textContent = '1';
        const plus = document.createElement('button');
        plus.type = 'button';
        plus.textContent = '+';

        minus.onclick = () => changeQty(id, p, -1, qtySpan, chk);
        plus.onclick = () => changeQty(id, p, 1, qtySpan, chk);

        qtyCol.appendChild(minus);
        qtyCol.appendChild(qtySpan);
        qtyCol.appendChild(plus);

        card.appendChild(img);
        card.appendChild(info);
        card.appendChild(checkCol);
        card.appendChild(qtyCol);

        productsEl.appendChild(card);
      });
    }

    async function createCheckout({ customerName, orderId, ttsText, items, totalPrice }) {
      const body = {
        customer_name: customerName,
        order_id: orderId,
        tts_text: ttsText,
        items,
        ammount: totalPrice
      };
      console.log('Criando checkout com', body);
      const res = await fetch(`${baseApi}/create_checkout_infinitepay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      let data = null;
      let raw = '';
      try {
        data = await res.json();
      } catch (err) {
        try { raw = await res.text(); } catch {}
      }

      if (!res.ok) {
        const message = data?.error || raw || `Erro ao criar checkout (HTTP ${res.status})`;
        throw new Error(message);
      }

      const checkoutUrl = data?.url || data?.data?.url;
      if (checkoutUrl) {
        window.location.href = checkoutUrl;
      } else {
        throw new Error('Resposta sem URL de checkout');
      }
    }

    function toggleProduct(id, produto, checked) {
      if (checked) {
        selections.set(id, { produto, qty: 1 });
      } else {
        selections.delete(id);
      }
    }

    function changeQty(id, produto, delta, qtySpan, chk) {
      let current = selections.get(id);
      if (!current) {
        if (delta > 0) {
          current = { produto, qty: 1 };
          selections.set(id, current);
          if (chk) chk.checked = true;
        } else {
          return;
        }
      }
      current.qty = Math.max(1, (current.qty || 1) + delta);
      qtySpan.textContent = String(current.qty);
    }

    function getValor(produto) {
      const raw = produto?.valor ?? produto?.price;
      const num = Number(raw);
      return Number.isFinite(num) && num > 0 ? num : 0;
    }

    function showProductsView() {
      summaryEl.style.display = 'none';
      productsEl.classList.remove('hidden');
      footerActionsEl.classList.remove('hidden');
    }

    function renderSummary() {
      const items = Array.from(selections.entries());
      if (!items.length) {
        showError('Selecione ao menos um produto.');
        showProductsView();
        return;
      }
      showError('');
      summaryListEl.innerHTML = '';
      let total = 0;
      items.forEach(([id, entry]) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'summary-item';

        const title = document.createElement('p');
        title.className = 'title';
        title.textContent = `${entry.qty}x ${entry.produto.title || entry.produto.nome || id}`;

        const meta = document.createElement('p');
        meta.className = 'meta';
        const valor = getValor(entry.produto);
        const subtotal = valor * (entry.qty || 1);
        total += subtotal;
        meta.textContent = `${formatPrice(valor)} cada • ${formatPrice(subtotal)} total`;

        wrapper.appendChild(title);
        wrapper.appendChild(meta);
        summaryListEl.appendChild(wrapper);
      });
      summaryTotalEl.textContent = 'Total: ' + formatPrice(total);
      summaryEl.style.display = 'block';
      productsEl.classList.add('hidden');
      footerActionsEl.classList.add('hidden');
      summaryEl.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('btn-prosseguir').onclick = renderSummary;
    backBtn.onclick = showProductsView;

    document.getElementById('btn-confirmar').onclick = async () => {
      try {
        const items = Array.from(selections.entries());
        if (!items.length) {
          showError('Selecione ao menos um produto.');
          return;
        }
        const nome = document.getElementById('final-name').value.trim() || 'Cliente';
        const ttsRaw = document.getElementById('final-tts').value || '';
        const tts = ttsRaw.trim().slice(0, 300);

        const itemList = items.map(([id, entry]) => ({
          description: id,
          amount: getValor(entry.produto),
          quantity: entry.qty || 1
        }));

        const total = itemList.reduce((acc, it) => acc + (it.amount || 0) * (it.quantity || 1), 0);
        const orderId = items.map(([id, entry]) => `${entry.qty}x${id}`).join('+');

        await createCheckout({
          customerName: nome,
          orderId,
          ttsText: tts,
          items: itemList,
          totalPrice: total || 1000
        });
      } catch (err) {
        console.error(err);
        showError(err.message || 'Erro ao iniciar checkout');
      }
    };

    // Auto-carrega quando possível
    loadConfig();
  </script>
</body>
</html>
